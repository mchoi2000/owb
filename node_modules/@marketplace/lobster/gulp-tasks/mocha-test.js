var gulp = require("gulp"),
    istanbul = require("gulp-istanbul"),
    mocha = require("gulp-mocha");

module.exports = function (done) {
    gulp.src([
        "lib/**/*.js"
    ])
    .pipe(istanbul({
        includeUntested: true
    }))
    .pipe(istanbul.hookRequire())
    .on("finish", function () {
        gulp.src(["test/**/*.js"])
            .pipe(mocha({
                reporter: "spec",
                timeout: 5000
            })
            )
            .pipe(istanbul.writeReports())
            .pipe(istanbul.enforceThresholds({
                thresholds: { global: 100 }
            }
        )).on("end", done);
    });
};
